package wallet

import (
	"encoding/hex"
	"strings"
	"testing"

	"github.com/monetarium/monetarium-node/wire"
)

func MsgTxFromHex(hexTx string) (*wire.MsgTx, error) {
	tx := new(wire.MsgTx)
	// Use DualCoinVersion (12) to deserialize legacy transaction data
	// that was serialized before SKABigIntVersion (13) wire format changes
	err := tx.BtcDecode(hex.NewDecoder(strings.NewReader(hexTx)), wire.DualCoinVersion)
	if err != nil {
		return nil, err
	}

	return tx, nil
}

func TestIsMixTx(t *testing.T) {
	t.Parallel()

	// 11x 2.68435456
	tx0, err := MsgTxFromHex(mix0Hex)
	if err != nil {
		t.Fatal(err)
	}

	coinbaseTx, err := MsgTxFromHex(coinbaseTxHex)
	if err != nil {
		t.Fatal(err)
	}

	tests := []struct {
		name         string
		tx           *wire.MsgTx
		want         bool
		wantDenom    int64
		wantMixTotal uint32
	}{
		{
			"ok",
			tx0,
			true,
			268435456,
			11,
		},
		{
			"no, coinbase",
			coinbaseTx,
			false,
			0,
			0,
		},
	}
	for _, tt := range tests {
		tt := tt
		t.Run(tt.name, func(t *testing.T) {
			t.Parallel()

			got, mixDenom, mixTotal := PossibleCoinJoin(tt.tx)
			if got != tt.want {
				t.Errorf("IsMixTx() got = %v, want %v", got, tt.want)
			}
			if mixDenom != tt.wantDenom {
				t.Errorf("IsMixTx() mixDenom = %v, want %v", mixDenom, tt.wantDenom)
			}
			if mixTotal != tt.wantMixTotal {
				t.Errorf("IsMixTx() mixTotal = %v, want %v", mixTotal, tt.wantMixTotal)
			}
		})
	}
}

const (
	// https://dcrdata.decred.org/tx/ab70b9b3fc88feb7be0c1a1b9ba47cac9dea10f158911fd9cfaf3af3f80878f3
	// Monetarium format with CoinType byte in TxOut
	mix0Hex = "010000000774cfd12c8a901bd9b0e5cd972c138e181339f3eef3429928e10851ca0bf436d3060000" +
		"00000000000074cfd12c8a901bd9b0e5cd972c138e181339f3eef3429928e10851ca0bf436d30d00" +
		"0000000000000074cfd12c8a901bd9b0e5cd972c138e181339f3eef3429928e10851ca0bf436d305" +
		"000000000000000042273af8bb2efe115c386772ff5b0d8d0a6575ad15c6041024db801c6fc73ef1" +
		"00000000000000000074cfd12c8a901bd9b0e5cd972c138e181339f3eef3429928e10851ca0bf436" +
		"d30f00000000000000000b3ce6daca6a00d7c5e46a337e2aa90715329571682cf17784ff87c92517" +
		"602a02000000000000000074cfd12c8a901bd9b0e5cd972c138e181339f3eef3429928e10851ca0b" +
		"f436d30e00000000000000001200000010000000000000001976a914409e179d979916e02f62eb50" +
		"cd78c3ad18e5da7188ac00000010000000000000001976a9141c5ef6cffd8b9bd71307e3e31593db" +
		"d9dde8e11b88ac00000010000000000000001976a914a7e73f5770db11bd485d0ff3207204088640" +
		"cd7888ac67949b08000000000000001976a91410137cd3bc70bc3e4a5b928ff96d7bd4ceeb900d88" +
		"ac00000010000000000000001976a91499dc818cef04904c7bd448b3687e39e2e5b1d7f488ac0000" +
		"0010000000000000001976a91413449fa707d58f73cc26dfbbd71ac57be6f471b888ac0000001000" +
		"0000000000001976a914c525a4b9fa8044db4188f549495a4d4820b4227a88ac0000001000000000" +
		"0000001976a914d1289d8e26dabeabe6240d077d32db4c54c0e13688acf384880e00000000000000" +
		"1976a914c687d7fce0075dd2ca7d2c41fb2cf3593d4136f888aced745b0a000000000000001976a9" +
		"1445a6a04c897c7b0de650a1e3ff1786b9114f85e388ac74dc1f03000000000000001976a9147173" +
		"915721ec13a190d0fea40f218cc6630b1fe388ac929b820a000000000000001976a914dcfe63662b" +
		"191222cb35bfc3e27eb1a553a528ea88ac00000010000000000000001976a91479e46b964fc1d630" +
		"a500254160add87c79249d4288ac8509ab0c000000000000001976a914eba47f950415bee6a69333" +
		"d70972e08ed054f05488ac00000010000000000000001976a914017d1e00b46c6bdf859a191365b8" +
		"f0b771434c8688ac3040cc03000000000000001976a914a2fb33165f035329e2a065ddcf7a53374a" +
		"b102b388ac00000010000000000000001976a9142a022b71c68a4b172ded65544f7bdc76b9fc2c94" +
		"88ac00000010000000000000001976a914e65f8ddc1a9d436f63de09acb353458d5bf4312b88ac00" +
		"000000000000000756e61f1300000000e30b0600020000006b483045022100feba46c31970f59f7a" +
		"781e4c7b04108d5a6dd1f717b103e6eda0bd5d4d26becb02207d3b310691196840a7143d529f2653" +
		"f3693b1ac512c47a3aa9fbb93c7e40570b0121039156b5ea23156f39e6dec5513ae0c5aad5f200f0" +
		"e25029e6439987ce6fc43f3f499e9b1800000000e30b0600020000006b483045022100ceac02bbe6" +
		"8b08734b5cc5cbbe505fddbd5d7c7c3834bba29060cf7bcfbaf5350220649a6228c3346781b5027f" +
		"e55c1a7291a8c52fb78b318044f31f031f9ec75a30012102e69f908fa65d96015f3b9185a40976b6" +
		"1e7c3e7aeec7ff2056aa70aa22feae33cf14ab2c00000000e30b0600020000006a4730440220186f" +
		"3006d499120c7ac0c915b62b4f24eb5f0223ca1238bb4e5bc94acec24e800220168a4b6574c14df2" +
		"e1e6c8d694c81a4a2db7fdb6d4ff3aff5dba5fa8d45f31d4012102a60330816caa5072884476c097" +
		"fea65a7b2119ff31c7e5677a4a61195c940580e24ccc3300000000db0b0600050000006b48304502" +
		"2100d173015d3094489a66db9e3c4df3d6c90cc42410b267abfaf5dbb0e824232c8f02200f33e951" +
		"f5bb03fafb50a5dcc2dc22895eb251f557139b1213100abb440c9bdd012103129bf6311a66c66d53" +
		"a14bf0339cf02c9335b03bbdbf4864589c1e1536ba3d1acf7e5b1a00000000e30b0600020000006a" +
		"473044022057b174cd2e7b94b77448b414cd6d00416d13795e2fff3056cf94174f471055bc022016" +
		"279190821ecb5bf128568f6e3e17e5683837f0ebb4c39e30e07498197ef011012102cf310775b179" +
		"5eb7dd103efbf016a4d41ebe9ed7b984ece6874d047e164f17f874a5821a00000000d70b06000700" +
		"00006b483045022100fd7147d2b7b925e256f837dab0eeeb9a3596b730d613b21807b1e385c15a63" +
		"8102206e77ca5c955e13ad05e6d9f2b108ebe0c0a6a39e7642399826e05361281c71540121024d8e" +
		"b3ea439f5bd1f352c94be3e35c5f77ad51fec0400531cbe90e3d70fce8853d90882e00000000e30b" +
		"0600020000006b48304502210084f10cf8efaf2e9cc8a04d4a7a50bdc8cb442a0f2f0778ddc2c2f5" +
		"d5d758ca9d022005c842f757964a4a7a14deff8bc76ff61c98a1f9ace3fc4924ba3b4a31f46f1f01" +
		"2102f29679b95edfd36df4cf76a46ac89015a928098f68808700298357682cad4cd3"

	// Monetarium format with CoinType byte in TxOut
	coinbaseTxHex = "01000000010000000000000000000000000000000000000000000000000000000000000000ffffff" +
		"ff00ffffffff037bf5d5090000000000000017a914f5916158e3e2c4551c1796708db8367207ed13" +
		"bb8700000000000000000000000e6a0c120c0600de23ddae861cb0a3ecec033b0000000000000019" +
		"76a91465b7889832ade1d1a90c0bb6f582f369cfdc446988ac0000000000000000015eb6d9440000" +
		"000000000000ffffffff0800002f646372642f"
)
